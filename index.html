<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5469196111567716" crossorigin="anonymous"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kurd GPT - اسألني وأنا أجاوبك صوتياً</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4A90E2 0%, #87CEEB 100%  );
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4A90E2 0%, #87CEEB 100%);
            color: white;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .flag {
            width: 50px;
            height: 35px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .instagram-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            text-decoration: none;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .instagram-link:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* Auth Screens */
        .auth-container {
            padding: 40px;
            text-align: center;
            display: block;
        }

        .auth-form {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
            max-width: 500px;
            margin: 20px auto;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            direction: rtl;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.3);
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }

        .auth-switch {
            color: #4A90E2;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 15px;
            display: inline-block;
        }

        .privacy-notice {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 14px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .privacy-notice .icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        /* Main Content */
        .main-content {
            padding: 30px;
            display: none;
        }

        .stats-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stats-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .online-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .offline-dot {
            width: 8px;
            height: 8px;
            background: #dc3545;
            border-radius: 50%;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .live-counter {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            text-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }

        .chat-container {
            display: flex;
            height: 500px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }

        .chat-sidebar {
            width: 200px;
            background: #f8f9fa;
            border-left: 2px solid #e9ecef;
            padding: 20px;
        }

        .chat-room {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: bold;
        }

        .chat-room.ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-room.help {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .chat-room:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .chat-room.active {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #4A90E2;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-members {
            font-size: 12px;
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
        }

        .message.user {
            background: #e3f2fd;
            margin-right: auto;
            border: 1px solid #bbdefb;
        }

        .message.other {
            background: #f5f5f5;
            margin-left: auto;
            border: 1px solid #e0e0e0;
        }

        .message.ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        .message-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .message.ai .message-header {
            color: rgba(255,255,255,0.8);
        }

        .chat-input-container {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
            direction: rtl;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4A90E2;
        }

        .send-btn {
            padding: 12px 20px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }

        .send-btn:hover {
            background: #357ABD;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 10px;
            margin-left: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .instagram-link {
                font-size: 11px;
                padding: 5px 10px;
            }
            
            .chat-container {
                height: 400px;
                flex-direction: column;
            }
            
            .chat-sidebar {
                width: 100%;
                height: 80px;
                display: flex;
                gap: 10px;
                padding: 10px;
                overflow-x: auto;
            }
            
            .chat-room {
                min-width: 80px;
                margin-bottom: 0;
                font-size: 12px;
                padding: 8px;
            }

            .stats-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .stats-section {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-main">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iMzUiIHZpZXdCb3g9IjAgMCA1MCAzNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjM1IiBmaWxsPSIjRkYwMDAwIi8+CjxyZWN0IHk9IjExLjY2NjciIHdpZHRoPSI1MCIgaGVpZ2h0PSIxMS42NjY3IiBmaWxsPSIjRkZGRkZGIi8+CjxyZWN0IHk9IjIzLjMzMzMiIHdpZHRoPSI1MCIgaGVpZ2h0PSIxMS42NjY3IiBmaWxsPSIjMDA4MDAwIi8+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMTcuNSIgcj0iNSIgZmlsbD0iI0ZGRkYwMCIvPgo8L3N2Zz4K" alt="Kurdistan Flag" class="flag">
                <h1>Kurd GPT</h1>
                <div class="user-info" id="userInfo">
                    <span id="userName"></span>
                    <button class="logout-btn" onclick="logout()">تسجيل خروج</button>
                </div>
            </div>
            <a href="https://www.instagram.com/redoan.m7?igsh=MTV2eXhyZXcyZTg0cQ==" target="_blank" class="instagram-link">
                📸 Instagram
            </a>
        </div>

        <!-- Auth Container -->
        <div class="auth-container" id="authContainer">
            <div class="auth-form" id="loginForm">
                <h2>تسجيل الدخول</h2>
                <div class="form-group">
                    <label>الاسم الأول:</label>
                    <input type="text" id="loginFirstName" placeholder="أدخل اسمك الأول">
                </div>
                <div class="form-group">
                    <label>اسم العائلة:</label>
                    <input type="text" id="loginLastName" placeholder="أدخل اسم العائلة">
                </div>
                <div class="form-group">
                    <label>المدينة:</label>
                    <input type="text" id="loginCity" placeholder="أدخل مدينتك">
                </div>
                <button class="auth-btn" onclick="login( )">تسجيل الدخول</button>
                <div class="auth-switch" onclick="showRegister()">إنشاء حساب جديد</div>
            </div>

            <div class="auth-form" id="registerForm" style="display: none;">
                <h2>إنشاء حساب جديد</h2>
                <div class="form-group">
                    <label>الاسم الأول:</label>
                    <input type="text" id="regFirstName" placeholder="أدخل اسمك الأول" required>
                </div>
                <div class="form-group">
                    <label>اسم العائلة:</label>
                    <input type="text" id="regLastName" placeholder="أدخل اسم العائلة" required>
                </div>
                <div class="form-group">
                    <label>تاريخ الميلاد:</label>
                    <input type="date" id="regBirthDate" required>
                </div>
                <div class="form-group">
                    <label>رقم الهاتف:</label>
                    <input type="tel" id="regPhone" placeholder="أدخل رقم هاتفك" required>
                </div>
                <div class="form-group">
                    <label>المدينة:</label>
                    <input type="text" id="regCity" placeholder="أدخل مدينتك" required>
                </div>
                
                <div class="privacy-notice">
                    <div class="icon">🔒</div>
                    <strong>جميع بياناتك محمية ومؤمنة</strong><br>
                    لا يمكن لأحد رؤية معلوماتك الشخصية<br>
                    الأعضاء الآخرون يمكنهم رؤية اسمك واسم العائلة فقط
                </div>
                
                <button class="auth-btn" onclick="register()">إنشاء الحساب</button>
                <div class="auth-switch" onclick="showLogin()">لديك حساب؟ تسجيل الدخول</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <div class="stats-bar">
                <div class="stats-section">
                    <div class="stat-item">
                        <span>👥</span>
                        <span>إجمالي الأعضاء: <span id="totalMembers">0</span></span>
                    </div>
                    <div class="stat-item">
                        <span>🟢</span>
                        <span>متصل الآن: <span id="onlineCount" class="live-counter">0</span></span>
                    </div>
                </div>
                <div class="online-status">
                    <div class="online-dot" id="connectionDot"></div>
                    <span id="connectionStatus">متصل</span>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-sidebar">
                    <div class="chat-room ai active" onclick="switchRoom('ai')">
                        🤖 الذكاء الاصطناعي
                    </div>
                    <div class="chat-room help" onclick="switchRoom('help')">
                        🆘 دردشة الطوارئ
                    </div>
                </div>
                <div class="chat-main">
                    <div class="chat-header" id="chatHeader">
                        <span>🤖 الذكاء الاصطناعي - KurdGPT</span>
                        <span class="room-members" id="roomMembers">الأعضاء النشطين: 1</span>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai">
                            <div class="message-header">KurdGPT</div>
                            مرحباً! أنا KurdGPT، ذكاءك الاصطناعي الشخصي. كيف يمكنني مساعدتك اليوم؟
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="messageInput" placeholder="اكتب رسالتك هنا..." onkeypress="handleKeyPress(event)">
                        <button class="send-btn" onclick="sendMessage()">إرسال</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentRoom = 'ai';
        let messages = {
            ai: [],
            help: []
        };
        let globalUsers = [];
        let onlineUsers = [];
        let lastActivity = Date.now();
        let activityInterval;
        let onlineCheckInterval;

        // Check if user is logged in
        function checkAuth() {
            const savedUser = localStorage.getItem('kurdgpt_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainContent();
            }
        }

        // Show/Hide forms
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        // Login function
        function login() {
            const firstName = document.getElementById('loginFirstName').value.trim();
            const lastName = document.getElementById('loginLastName').value.trim();
            const city = document.getElementById('loginCity').value.trim();

            if (!firstName || !lastName || !city) {
                alert('يرجى ملء جميع الحقول');
                return;
            }

            currentUser = {
                firstName: firstName,
                lastName: lastName,
                city: city,
                fullName: firstName + ' ' + lastName,
                id: Date.now() + Math.random(),
                lastSeen: new Date().toISOString()
            };

            localStorage.setItem('kurdgpt_user', JSON.stringify(currentUser));
            addUserToGlobalList();
            showMainContent();
        }

        // Register function
        function register() {
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const birthDate = document.getElementById('regBirthDate').value;
            const phone = document.getElementById('regPhone').value.trim();
            const city = document.getElementById('regCity').value.trim();

            if (!firstName || !lastName || !birthDate || !phone || !city) {
                alert('يرجى ملء جميع الحقول');
                return;
            }

            currentUser = {
                firstName: firstName,
                lastName: lastName,
                birthDate: birthDate,
                phone: phone,
                city: city,
                fullName: firstName + ' ' + lastName,
                id: Date.now() + Math.random(),
                registrationDate: new Date().toISOString(),
                lastSeen: new Date().toISOString()
            };

            // Send user data to admin (simulate sending to server)
            sendUserDataToAdmin(currentUser);

            localStorage.setItem('kurdgpt_user', JSON.stringify(currentUser));
            addUserToGlobalList();
            showMainContent();
        }

        // Send user data to admin (simulate)
        function sendUserDataToAdmin(userData) {
            // In a real application, this would send data to your server
            console.log('بيانات المستخدم الجديد:', {
                name: userData.fullName,
                birthDate: userData.birthDate,
                phone: userData.phone,
                city: userData.city,
                registrationDate: userData.registrationDate
            });
            
            // Store in localStorage for demo purposes
            let adminData = JSON.parse(localStorage.getItem('admin_users') || '[]');
            adminData.push({
                name: userData.fullName,
                birthDate: userData.birthDate,
                phone: userData.phone,
                city: userData.city,
                registrationDate: userData.registrationDate
            });
            localStorage.setItem('admin_users', JSON.stringify(adminData));
        }

        // Add user to global list
        function addUserToGlobalList() {
            let users = JSON.parse(localStorage.getItem('global_users') || '[]');
            const existingUserIndex = users.findIndex(u => u.id === currentUser.id);
            
            if (existingUserIndex !== -1) {
                users[existingUserIndex] = {
                    ...users[existingUserIndex],
                    lastSeen: new Date().toISOString(),
                    isOnline: true
                };
            } else {
                users.push({
                    id: currentUser.id,
                    fullName: currentUser.fullName,
                    firstName: currentUser.firstName,
                    lastName: currentUser.lastName,
                    lastSeen: new Date().toISOString(),
                    isOnline: true
                });
            }
            
            localStorage.setItem('global_users', JSON.stringify(users));
            globalUsers = users;
            updateOnlineUsers();
            updateMemberCount();
        }

        // Update online users
        function updateOnlineUsers() {
            const now = Date.now();
            const fiveMinutesAgo = now - (5 * 60 * 1000); // 5 minutes ago
            
            // Get all users and check who was active in the last 5 minutes
            onlineUsers = globalUsers.filter(user => {
                const lastSeen = new Date(user.lastSeen).getTime();
                return lastSeen > fiveMinutesAgo;
            });
            
            // Add some simulated online users for demo
            const simulatedOnlineCount = Math.floor(Math.random() * 8) + 2; // 2-9 random online users
            const currentOnlineCount = Math.max(onlineUsers.length, simulatedOnlineCount);
            
            document.getElementById('onlineCount').textContent = currentOnlineCount;
            
            // Update connection status
            updateConnectionStatus();
        }

        // Update connection status
        function updateConnectionStatus() {
            const connectionDot = document.getElementById('connectionDot');
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (navigator.onLine) {
                connectionDot.className = 'online-dot';
                connectionStatus.textContent = 'متصل';
            } else {
                connectionDot.className = 'offline-dot';
                connectionStatus.textContent = 'غير متصل';
            }
        }

        // Update member count
        function updateMemberCount() {
            const totalCount = globalUsers.length;
            document.getElementById('totalMembers').textContent = totalCount;
            
            const onlineCount = parseInt(document.getElementById('onlineCount').textContent);
            const roomMembersText = currentRoom === 'ai' ? 
                'الأعضاء النشطين: 1' : 
                `الأعضاء النشطين: ${onlineCount}`;
            document.getElementById('roomMembers').textContent = roomMembersText;
        }

        // Update user activity
        function updateActivity() {
            lastActivity = Date.now();
            if (currentUser) {
                currentUser.lastSeen = new Date().toISOString();
                localStorage.setItem('kurdgpt_user', JSON.stringify(currentUser));
                addUserToGlobalList();
            }
        }

        // Show main content
        function showMainContent() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.fullName;
            
            // Load global users
            globalUsers = JSON.parse(localStorage.getItem('global_users') || '[]');
            updateOnlineUsers();
            updateMemberCount();
            
            // Load saved messages
            const savedMessages = localStorage.getItem('kurdgpt_messages');
            if (savedMessages) {
                messages = JSON.parse(savedMessages);
            }
            
            // Start activity tracking
            startActivityTracking();
            
            loadMessages();
        }

        // Start activity tracking
        function startActivityTracking() {
            // Update activity every 30 seconds
            activityInterval = setInterval(updateActivity, 30000);
            
            // Update online count every 10 seconds
            onlineCheckInterval = setInterval(updateOnlineUsers, 10000);
            
            // Track user interactions
            document.addEventListener('click', updateActivity);
            document.addEventListener('keypress', updateActivity);
            document.addEventListener('scroll', updateActivity);
            
            // Track online/offline status
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // Initial activity update
            updateActivity();
        }

        // Stop activity tracking
        function stopActivityTracking() {
            if (activityInterval) {
                clearInterval(activityInterval);
            }
            if (onlineCheckInterval) {
                clearInterval(onlineCheckInterval);
            }
            
            document.removeEventListener('click', updateActivity);
            document.removeEventListener('keypress', updateActivity);
            document.removeEventListener('scroll', updateActivity);
            window.removeEventListener('online', updateConnectionStatus);
            window.removeEventListener('offline', updateConnectionStatus);
        }

        // Logout function
        function logout() {
            // Mark user as offline
            if (currentUser) {
                let users = JSON.parse(localStorage.getItem('global_users') || '[]');
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex].isOnline = false;
                    users[userIndex].lastSeen = new Date().toISOString();
                    localStorage.setItem('global_users', JSON.stringify(users));
                }
            }
            
            stopActivityTracking();
            localStorage.removeItem('kurdgpt_user');
            currentUser = null;
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            
            // Clear forms
            document.getElementById('loginFirstName').value = '';
            document.getElementById('loginLastName').value = '';
            document.getElementById('loginCity').value = '';
            document.getElementById('regFirstName').value = '';
            document.getElementById('regLastName').value = '';
            document.getElementById('regBirthDate').value = '';
            document.getElementById('regPhone').value = '';
            document.getElementById('regCity').value = '';
            showLogin();
        }

        // Switch chat room
        function switchRoom(room) {
            currentRoom = room;
            
            // Update active room
            document.querySelectorAll('.chat-room').forEach(r => r.classList.remove('active'));
            document.querySelector(`.chat-room.${room}`).classList.add('active');
            
            // Update header
            const headers = {
                ai: '🤖 الذكاء الاصطناعي - KurdGPT',
                help: '🆘 دردشة الطوارئ'
            };
            document.getElementById('chatHeader').querySelector('span').textContent = headers[room];
            
            updateMemberCount();
            loadMessages();
            updateActivity();
        }

        // Load messages for current room
        function loadMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            if (currentRoom === 'ai') {
                // AI welcome message
                const welcomeMsg = document.createElement('div');
                welcomeMsg.className = 'message ai';
                welcomeMsg.innerHTML = `
                    <div class="message-header">KurdGPT</div>
                    مرحباً ${currentUser.fullName}! أنا KurdGPT، ذكاءك الاصطناعي الشخصي. كيف يمكنني مساعدتك اليوم؟
                `;
                chatMessages.appendChild(welcomeMsg);
            }
            
            // Load saved messages for current room
            if (messages[currentRoom]) {
                messages[currentRoom].forEach(msg => {
                    // Only show messages from current user in help room for privacy
                    if (currentRoom === 'help' && msg.userId !== currentUser.id) {
                        return;
                    }
                    addMessageToChat(msg.text, msg.sender, msg.timestamp, false);
                });
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            
            if (currentRoom === 'ai') {
                // Add user message
                addMessageToChat(text, currentUser.fullName, timestamp);
                
                // Simulate AI response
                setTimeout(() => {
                    const aiResponses = [
                        'شكراً لك على سؤالك! هذا موضوع مثير للاهتمام.',
                        'أفهم ما تقصده. دعني أساعدك في هذا الأمر.',
                        'هذا سؤال رائع! إليك ما أعرفه عن هذا الموضوع...',
                        'يمكنني مساعدتك في ذلك. هل تريد المزيد من التفاصيل؟',
                        'ممتاز! هذا يذكرني بموضوع مشابه...'
                    ];
                    const randomResponse = aiResponses[Math.floor(Math.random() * aiResponses.length)];
                    addMessageToChat(randomResponse, 'KurdGPT', new Date().toLocaleTimeString('ar-SA'));
                }, 1000);
            } else {
                // Emergency chat - messages are private to each user
                addMessageToChat(text, currentUser.fullName, timestamp);
            }
            
            input.value = '';
            updateActivity();
        }

        // Add message to chat
        function addMessageToChat(text, sender, timestamp, save = true) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            let messageClass = 'message ';
            if (sender === 'KurdGPT') {
                messageClass += 'ai';
            } else if (sender === currentUser.fullName) {
                messageClass += 'user';
            } else {
                messageClass += 'other';
            }
            
            messageDiv.className = messageClass;
            messageDiv.innerHTML = `
                <div class="message-header">${sender} - ${timestamp}</div>
                ${text}
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Save message
            if (save && sender !== 'KurdGPT') {
                if (!messages[currentRoom]) {
                    messages[currentRoom] = [];
                }
                messages[currentRoom].push({
                    text: text,
                    sender: sender,
                    timestamp: timestamp,
                    userId: currentUser.id
                });
                localStorage.setItem('kurdgpt_messages', JSON.stringify(messages));
            }
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Initialize
        window.onload = function() {
            checkAuth();
            updateConnectionStatus();
        };

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                // Mark user as going offline
                let users = JSON.parse(localStorage.getItem('global_users') || '[]');
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex].lastSeen = new Date().toISOString();
                    localStorage.setItem('global_users', JSON.stringify(users));
                }
            }
            stopActivityTracking();
        });
    </script>
</body>
</html>
